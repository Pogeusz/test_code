from airflow.decorators import dag, task
from airflow.utils.dates import days_ago
from datetime import timedelta
import requests
import subprocess
import json

# Define the default arguments
default_args = {
    'owner': 'airflow',
    'depends_on_past': False,
    'start_date': days_ago(1),
    'email_on_failure': False,
    'email_on_retry': False,
    'retries': 1,
    'retry_delay': timedelta(minutes=5),
}

# Define the DAG using the @dag decorator
@dag(
    default_args=default_args,
    description='A DAG that traces route and calls an API with a URL provided at runtime',
    schedule_interval=None,  # Only triggered manually
    params={'url': 'http://default-api-url'},  # Default URL parameter
    catchup=False
)
def call_api_with_trace_route():

    @task
    def trace_route(url: str):
        from urllib.parse import urlparse
        import socket

        # Extract the hostname from the URL
        parsed_url = urlparse(url)
        hostname = parsed_url.hostname

        if not hostname:
            raise ValueError("Invalid URL")

        # Get the IP address of the hostname
        ip_address = socket.gethostbyname(hostname)
        
        # Initialize pyroute2 IPRoute
        ipr = IPRoute()

        # Perform traceroute
        max_hops = 30
        timeout = 2
        hops = []

        for ttl in range(1, max_hops + 1):
            response = ipr.route('get', {'dst': ip_address, 'ttl': ttl, 'timeout': timeout})
            if not response:
                print(f"{ttl} *")
                hops.append(f"{ttl} *")
            else:
                print(f"{ttl} {response[0]['attrs'][0][1]}")
                hops.append(f"{ttl} {response[0]['attrs'][0][1]}")
                if response[0]['attrs'][0][1] == ip_address:
                    break

        ipr.close()
        print(f"Traceroute result:\n{''.join(hops)}")

    @task
    def call_api(url: str):
        if not url:
            raise ValueError("URL parameter is required")

        # Set up headers and payload
        headers = {
            'Content-Type': 'application/json'
        }
        payload = {
            'projectName': 'default_project',
            'feed_name': 'default_feed'
        }

        # Make the POST request
        response = requests.post(url, headers=headers, data=json.dumps(payload))
        
        if response.status_code == 200:
            print(f"API Response: {response.json()}")
        else:
            print(f"Failed to call API. Status code: {response.status_code}, Response: {response.text}")

    # Get the URL parameter from the DAG run configuration
    url = '{{ dag_run.conf.get("url", params.url) }}'

    # Define the task dependencies
    trace_route(url) >> call_api(url)

# Instantiate the DAG
dag = call_api_with_trace_route()
